<%= javascript_include_tag "games" %>
<%= stylesheet_link_tag    "games" %>

<%= content_tag :div, id: "game-data", data: {game: @game.to_json(:include => :moves), userid: current_user.id} do %>
<% end %>

<canvas id="myCanvas" width="700" height="600"></canvas>
<script>

  var dispatcher = new WebSocketRails(window.location.host + "/websocket", true)

  var canvas = document.getElementById('myCanvas');
  var ctx = canvas.getContext('2d');
  var N = 30;
  var HEIGHT = canvas.height
  var WIDTH = canvas.height //make it square
  var BAR_WIDTH = canvas.width-canvas.height
  var SQ_WIDTH = Math.floor(WIDTH/N)
  var GAME_DATA = $('#game-data').data("game")
  var USERID = $('#game-data').data("userid")
  var pid = ((USERID == GAME_DATA.player_1_id) ? Turn.First : Turn.Second)
  var SHIPS = [];

  // game logistics
  var game = new Game(ctx);

  // Inputs
  window.addEventListener('keydown', check, false);
  window.addEventListener("mousedown", click, false);
  window.addEventListener("mousemove", hover, false);

  function check(e) {
    var code = e.keyCode;
    switch (code) {
      case 13:  request_move(1,1,0, "Move"); break;
      case 39:  game.NextShipDown(); break; // Right key
      case 37:  game.NextShipUp(); break; // Left key
      default:  //Everything else
    }
  }
  function click(e) {
  
    var x = e.x-canvas.getBoundingClientRect().left;
    var y = e.y-canvas.getBoundingClientRect().top;
    
    // check if in grid or on sidebar
    if(x>0 && x<WIDTH && y>0 && y<WIDTH){
      // on grid
      ctx.fillStyle = "yellow";
		ctx.fillRect(x,y,10,10);
      
    }else if(x>=WIDTH && x<WIDTH+BAR_WIDTH && y>0 && y<WIDTH){
      // on sidebar
      game.sidebar.Hover(x,y);
    }

  }
  function hover(e) {
    var x = e.x-canvas.getBoundingClientRect().left;
    var y = e.y-canvas.getBoundingClientRect().top;
    
    // check if in grid or on sidebar
    if(x>0 && x<WIDTH && y>0 && y<WIDTH){
      // on grid
      ctx.fillStyle = "green";
		ctx.fillRect(x,y,10,10);
      
    }else if(x>=WIDTH && x<WIDTH+BAR_WIDTH && y>0 && y<WIDTH){
      // on sidebar
      ctx.fillStyle = "purple";
      ctx.fillRect(x,y,10,10);
    }
  }
  


  setInterval(function () {
    ctx.clearRect(0, 0, WIDTH, HEIGHT);
    game.Display();
  }, 36);

</script>
